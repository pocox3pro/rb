env:
    rclone_config: "ENCRYPTED[3d228a57e80020e805e9e127a96e893c637cbe5559757d3c73781a89fb73ac89636814dec5295c6eb099d5293bd6b119]"
    bot_api: "ENCRYPTED[81cbfdf0eb30e6be3a217e102e753c3ec1f3b2a8515125799f695282e3021518248023ffd4ed608ecfdd7721d4c394e2]"
    tg_id: "ENCRYPTED[8718d1657e15b3fa1876d485284c244a9814c46f75a84842999569b4216070a8d9b74f94136adadd52cdbb1550b3050b]"
    git_token: "ENCRYPTED[275899439d04b9f40e8ccede8a6a320c84e4dd59f82561a5b290eb2f0329c7dc39fb587e5e5709dc84dedc83a6b616de]"

task:
    name: cirrus-ci.org
    timeout_in: 120m
    container:
      dockerfile: Dockerfile
      cpu: 8
      memory: 32G

    memantau_setup_script:
      - mkdir -p ~/.config/rclone
      - echo "$rclone_config" > ~/.config/rclone/rclone.conf
    memantau_background_script:
      - curl -s "https://api.telegram.org/bot${bot_api}/sendmessage" --data "text=Download ccache started at $(date)&chat_id=${tg_id}&parse_mode=html"
      - df -h && free -h && nproc && cat /etc/os* && env
      - curl https://ap.apd1.workers.dev/4:/havoc/ccache.tar.gz -o /tmp/ccache.tar.gz
      - cd /tmp
      - time tar xf ccache.tar.gz
      - rm -rf ccache.tar.gz
    mengsinkronisasi_script:
      - curl -s "https://api.telegram.org/bot${bot_api}/sendmessage" --data "text=Havoc Sync started at $(date)&chat_id=${tg_id}&parse_mode=html"
      - git config --global  user.name "rahul9999xda"
      - git config --global  user.email "rahul9999xda@gmail.com"
      - mkdir -p /tmp/rom
      - cd /tmp/rom
      - repo init -q --no-repo-verify --depth=1 -u https://github.com/PocoX3Pro-Havoc-OS/android_manifest.git -b private -g default,-device,-mips,-darwin,-notdefault
      - git clone https://github.com/pocox3pro/Local-Manifests.git --depth 1 -b havoc .repo/local_manifests
      - repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j 30 || repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j 8
      - git clone https://rahul9999xda:$git_token@github.com/Havoc-OS/frameworks_base frameworks/base
      - git clone https://rahul9999xda:$git_token@github.com/Havoc-OS/packages_apps_Settings packages/apps/Settings
      - git clone https://rahul9999xda:$git_token@github.com/Havoc-OS/android_packages_apps_Updater packages/apps/Updater
      - git clone https://rahul9999xda:$git_token@github.com/Havoc-OS/packages_apps_ConfigCenter packages/apps/ConfigCenter
      - git clone https://rahul9999xda:$git_token@github.com/Havoc-OS/android_external_faceunlock external/faceunlock
    mengumpulkan_script:
      - cd /tmp/rom
      - curl -s "https://api.telegram.org/bot${bot_api}/sendmessage" --data "text=Havoc Build started at $(date)&chat_id=${tg_id}&parse_mode=html"
      - . build/envsetup.sh
      - lunch havoc_vayu-user
      - export CCACHE_DIR=/tmp/ccache
      - export CCACHE_EXEC=$(which ccache)
      - export USE_CCACHE=1
      - export WITH_GAPPS=true
      - export TARGET_GAPPS_ARCH=arm64
      - ccache -M 20G
      - ccache -o compression=true
      - ccache -z
      - mka bacon -j8 &
      - sleep 90m
      - kill %1
      - ccache -s
#      - mka bacon -j8
      - time rclone copy /tmp/rom/out/error.log remote:havoc -P
    mengunggah_script:
      - ./mengunggah
